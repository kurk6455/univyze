<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Options</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    /* Custom styles for QR code and status dots */
    .qr-placeholder {
      width: 100px;
      height: 100px;
      background-color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }
    .status-dot.green {
      background-color: #22c55e;
    }
    .status-dot.red {
      background-color: #ef4444;
    }
    /* Modal for QR scanner */
    .scanner-modal {
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .scanner-modal video {
      width: 100%;
      max-width: 400px;
      border-radius: 8px;
    }
    .scanner-modal-content {
      background-color: white;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
    }
  </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

  <div class="bg-white shadow-lg rounded-xl p-6 w-full max-w-lg">
    <!-- Options View -->
    <div id="optionsView">
      <!-- Search Bar and Toggle Button -->
      <div class="flex items-center space-x-2 mb-4">
        <input 
          id="searchInput"
          type="text" 
          placeholder="üîç Search topics..." 
          class="w-3/4 p-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-indigo-400"
        />
        <button id="toggleViewBtn" class="px-3 py-1 rounded-lg bg-indigo-600 text-white text-sm font-medium hover:bg-indigo-800 transition">
          Download View
        </button>
      </div>

      <!-- Topics -->
      <div id="topicsContainer" class="mt-4 flex flex-wrap gap-2 max-h-72 overflow-y-auto">
        <!-- Topic buttons will load here -->
      </div>

      <!-- Download Message -->
      <div id="downloadMessage" class="mt-4 text-center text-green-600 hidden"></div>

      <!-- Reset and Go Back -->
      <div class="mt-4 text-center space-x-4">
        <button 
          onclick="resetSearch()" 
          class="text-sm text-gray-500 hover:text-red-500"
        >
          ‚ü≥ Reset
        </button>
        <a 
          href="./index.html" 
          class="text-sm text-gray-500 hover:text-indigo-600"
        >
          üè† Go Back to Home
        </a>
      </div>
    </div>

    <!-- Download View -->
    <div id="downloadView" class="hidden">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-indigo-700">Completed Downloads</h2>
        <!-- Toggle Button moved here dynamically -->
      </div>
      <div id="downloadedTopics" class="mb-6 flex flex-col gap-4">
        <!-- Downloaded topics with QR codes -->
      </div>
      <div id="pendingDownloadsSection" class="hidden">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold text-indigo-700">Pending Downloads</h2>
          <button id="globalScanBtn" class="px-3 py-1 rounded-lg bg-red-600 text-white text-sm font-medium hover:bg-red-800 transition hidden">
            Scan QR
          </button>
        </div>
        <div id="notDownloadedTopics" class="flex flex-col gap-4">
          <!-- Staged topics for download -->
        </div>
      </div>
    </div>

    <!-- QR Scanner Modal -->
    <div id="scannerModal" class="scanner-modal hidden">
      <div class="scanner-modal-content">
        <video id="scannerVideo" autoplay playsinline></video>
        <p id="scannerStatus" class="mt-2 text-sm text-gray-700">Scanning for QR code...</p>
        <button id="closeScannerBtn" class="mt-4 px-4 py-2 rounded-lg bg-red-600 text-white font-medium hover:bg-red-800 transition">
          Close
        </button>
      </div>
    </div>
  </div>

  <script>
    const topics = [
      "Magnetism", "Electricity", "Waves", "Optics", "Thermodynamics",
      "Biology", "Genetics", "Evolution", "Chemistry", "Organic Chemistry",
      "Algebra", "Geometry", "Trigonometry", "Calculus", "Probability",
      "History", "Geography", "Civics", "Economics", "Philosophy"
    ];

    // Hardcode Magnetism as downloaded for demo (replace with backend data)
    const downloadedTopics = ["Magnetism"];
    const notDownloadedTopics = topics.filter(t => !downloadedTopics.includes(t));
    let stagedTopics = []; // Tracks topics selected for download
    let stream = null; // Store camera stream for cleanup

    // Hardcoded Magnetism data for QR code
    const magnetismData = [
      {
        type: 'fill-in-the-blanks',
        prompt: 'A magnet has two poles: the _____ pole and the south pole.',
        correctAnswer: 'north',
        feedback: 'Magnets always have a north and south pole. Like poles repel, and unlike poles attract.'
      },
      {
        type: 'multiple-choice',
        prompt: 'What happens when two north poles of magnets are brought close together?',
        options: ["They attract", "They repel", "They become neutral", "They create a spark"],
        correctAnswer: "They repel",
        feedback: 'Like poles repel each other due to magnetic fields.'
      },
      {
        type: 'multiple-choice',
        prompt: 'What material can block magnetic fields?',
        options: ["Copper", "Iron", "Mu-metal", "Aluminum"],
        correctAnswer: "Mu-metal",
        feedback: 'Mu-metal is a nickel-iron alloy used for magnetic shielding.'
      }
    ];

    const container = document.getElementById("topicsContainer");
    const searchInput = document.getElementById("searchInput");
    const downloadMessage = document.getElementById("downloadMessage");
    const toggleViewBtn = document.getElementById("toggleViewBtn");
    const optionsView = document.getElementById("optionsView");
    const downloadView = document.getElementById("downloadView");
    const downloadedTopicsContainer = document.getElementById("downloadedTopics");
    const notDownloadedTopicsContainer = document.getElementById("notDownloadedTopics");
    const pendingDownloadsSection = document.getElementById("pendingDownloadsSection");
    const globalScanBtn = document.getElementById("globalScanBtn");
    const scannerModal = document.getElementById("scannerModal");
    const scannerVideo = document.getElementById("scannerVideo");
    const scannerStatus = document.getElementById("scannerStatus");
    const closeScannerBtn = document.getElementById("closeScannerBtn");

    // Render Options View
    function renderTopics(filter = "") {
      container.innerHTML = "";
      topics
        .filter(t => t.toLowerCase().includes(filter.toLowerCase()))
        .forEach(topic => {
          const btn = document.createElement("button");
          btn.innerText = topic;
          btn.className = "px-4 py-2 rounded-full text-sm";
          if (topic === "Magnetism") {
            btn.className += " bg-green-500 text-white";
            btn.onclick = () => {
              window.location.href = "/learning.html";
            };
          } else {
            btn.className += stagedTopics.includes(topic) ? " bg-red-200" : " bg-gray-200";
            btn.onclick = () => {
              if (stagedTopics.includes(topic)) {
                stagedTopics = stagedTopics.filter(t => t !== topic);
                btn.className = btn.className.replace("bg-red-200", "bg-gray-200");
                downloadMessage.innerText = "Removed from queue: " + topic;
                downloadMessage.classList.remove("hidden");
                setTimeout(() => downloadMessage.classList.add("hidden"), 2000);
              } else {
                stagedTopics.push(topic);
                btn.className = btn.className.replace("bg-gray-200", "bg-red-200");
                downloadMessage.innerText = "Added to queue: " + topic;
                downloadMessage.classList.remove("hidden");
                setTimeout(() => downloadMessage.classList.add("hidden"), 2000);
                axios.post('/api/topic', { topic: topic })
                  .then(response => console.log(response.data))
                  .catch(error => console.error('Error:', error));
              }
            };
          }
          container.appendChild(btn);
        });
    }

    // Render Download View
    function renderDownloadView() {
      // Downloaded Topics with QR Codes
      downloadedTopicsContainer.innerHTML = "";
      downloadedTopics.forEach(topic => {
        const div = document.createElement("div");
        div.className = "flex flex-col items-center p-3 bg-gray-100 rounded-lg";
        const qrCanvas = document.createElement("canvas");
        qrCanvas.className = "w-[100px] h-[100px] rounded-lg mt-2";
        div.innerHTML = `
          <span class="text-gray-700 font-medium">${topic}</span>
        `;
        div.appendChild(qrCanvas);
        downloadedTopicsContainer.appendChild(div);
        // Generate QR code for Magnetism with JSON data, fallback to URL for other topics
        const qrData = topic === "Magnetism" ? JSON.stringify(magnetismData) : `/learning.html?topic=${encodeURIComponent(topic)}`;
        QRCode.toCanvas(qrCanvas, qrData, {
          width: 100,
          height: 100,
          margin: 1,
          color: { dark: "#000000", light: "#ffffff" }
        }, (error) => {
          if (error) console.error('QR Code generation error:', error);
        });
      });

      // Pending Downloads (only show if stagedTopics exist)
      if (stagedTopics.length > 0) {
        pendingDownloadsSection.classList.remove("hidden");
        globalScanBtn.classList.remove("hidden");
      } else {
        pendingDownloadsSection.classList.add("hidden");
        globalScanBtn.classList.add("hidden");
      }
      notDownloadedTopicsContainer.innerHTML = "";
      const isOnline = navigator.onLine;
      stagedTopics.forEach(topic => {
        const div = document.createElement("div");
        div.className = "flex items-center justify-between p-3 bg-gray-100 rounded-lg";
        if (isOnline) {
          // Online: Green dot, send download request
          div.innerHTML = `
            <div class="flex items-center">
              <span class="status-dot green"></span>
              <span class="text-gray-700 font-medium">${topic}</span>
            </div>
            <button class="px-3 py-1 rounded-lg bg-indigo-600 text-white font-medium hover:bg-indigo-800 transition download-btn" data-topic="${topic}">
              Download
            </button>
          `;
          div.querySelector(".download-btn").onclick = () => {
            axios.post('/api/topic', { topic: topic })
              .then(response => {
                console.log(response.data);
                alert(`Download started for ${topic}`);
              })
              .catch(error => console.error('Error:', error));
          };
        } else {
          // Offline: Red dot, Bluetooth text only
          div.innerHTML = `
            <div class="flex items-center">
              <span class="status-dot red"></span>
              <span class="text-gray-700 font-medium">${topic}</span>
            </div>
            <div class="flex items-center">
              <span class="text-sm text-gray-500">Looking for nearby Bluetooth device</span>
            </div>
          `;
        }
        notDownloadedTopicsContainer.appendChild(div);
      });
    }

    // QR Scanner Logic
    let scanning = false;
    function startQRScanner() {
      if (scanning) return;
      scanning = true;
      scannerModal.classList.remove("hidden");
      scannerStatus.innerText = "Scanning for QR code...";

      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(mediaStream => {
          stream = mediaStream;
          scannerVideo.srcObject = stream;
          scannerVideo.play();

          const canvas = document.createElement("canvas");
          const context = canvas.getContext("2d");

          function scan() {
            if (!scanning) return;
            canvas.width = scannerVideo.videoWidth;
            canvas.height = scannerVideo.videoHeight;
            if (canvas.width > 0 && canvas.height > 0) {
              context.drawImage(scannerVideo, 0, 0, canvas.width, canvas.height);
              const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
              const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert"
              });
              if (code) {
                stopQRScanner();
                try {
                  // Attempt to parse as JSON
                  const parsedData = JSON.parse(code.data);
                  scannerStatus.innerText = "QR Code detected: Magnetism questions loaded.";
                  alert(`Scanned Magnetism questions: ${JSON.stringify(parsedData, null, 2)}`);
                  // Optionally process the questions (e.g., render on learning.html)
                } catch (e) {
                  // Fallback for non-JSON data (e.g., URLs)
                  scannerStatus.innerText = `QR Code detected: ${code.data}`;
                  alert(`Scanned QR code: ${code.data}`);
                }
              } else {
                requestAnimationFrame(scan);
              }
            } else {
              requestAnimationFrame(scan);
            }
          }
          requestAnimationFrame(scan);
        })
        .catch(error => {
          scannerStatus.innerText = "Camera access denied or unavailable.";
          console.error('Camera error:', error);
        });
    }

    function stopQRScanner() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      scanning = false;
      scannerModal.classList.add("hidden");
      scannerVideo.srcObject = null;
    }

    // Global Scan Button
    globalScanBtn.addEventListener("click", () => {
      startQRScanner();
    });

    // Close Scanner Button
    closeScannerBtn.addEventListener("click", () => {
      stopQRScanner();
    });

    // Toggle between Options and Download views
    toggleViewBtn.addEventListener("click", () => {
      if (optionsView.classList.contains("hidden")) {
        optionsView.classList.remove("hidden");
        downloadView.classList.add("hidden");
        toggleViewBtn.innerText = "Download View";
        // Move toggle button back to Options view
        document.querySelector("#optionsView .flex.items-center").appendChild(toggleViewBtn);
      } else {
        optionsView.classList.add("hidden");
        downloadView.classList.remove("hidden");
        toggleViewBtn.innerText = "Options View";
        // Move toggle button to Download view (under Completed Downloads)
        document.querySelector("#downloadView .flex.justify-between").appendChild(toggleViewBtn);
        renderDownloadView();
      }
    });

    // Reset Search
    function resetSearch() {
      searchInput.value = "";
      downloadMessage.classList.add("hidden");
      stagedTopics = []; // Clear staged topics
      renderTopics();
    }

    // Initial load
    renderTopics();
  </script>

</body>
</html>