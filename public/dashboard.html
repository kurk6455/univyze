<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Univyze Dashboard ‚Äî Full</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background:
                linear-gradient(rgba(248, 250, 252, 0.9), rgba(248, 250, 252, 0.9)),
                url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1470&q=80') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
        }
        .soft-card {
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 6px 20px rgba(2, 6, 23, 0.06);
        }
        .xp-circle {
            transform: rotate(-90deg);
        }
        .min-w-0 {
            min-width: 0;
        }
        button:hover {
            filter: brightness(0.9);
            transition: filter 0.2s ease-in-out;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-banner {
            background: #fee2e2;
            color: #dc2626;
            padding: 8px;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
        }
        .role-pill {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .role-student {
            background: #bfdbfe;
            color: #1e40af;
        }
        .role-teacher {
            background: #dcfce7;
            color: #166534;
        }
    </style>
</head>
<body class="min-h-screen flex">
    <main class="flex-1 max-w-7xl mx-auto px-4 py-8 grid lg:grid-cols-12 gap-6 w-full">
        <aside class="lg:col-span-3 col-span-12 soft-card p-6 flex flex-col gap-6">
            <div class="flex flex-col items-center gap-3">
                <img id="userAvatar" src="https://via.placeholder.com/100" class="w-24 h-24 rounded-full border object-cover" alt="User avatar">
                <div class="text-center">
                    <div id="userName" class="font-semibold text-lg">User</div>
                    <div id="userRole" class="text-xs text-gray-500 role-pill role-student">Student</div>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-3 text-center">
                <div>
                    <div class="text-sm text-gray-500">Crowns</div>
                    <div id="statCrowns" class="font-bold text-indigo-600">0</div>
                </div>
                <div>
                    <div class="text-sm text-gray-500">Streak</div>
                    <div id="statStreak" class="font-bold text-amber-500">0</div>
                </div>
                <div>
                    <div class="text-sm text-gray-500">Gems</div>
                    <div id="statGems" class="font-bold text-pink-500">0</div>
                </div>
            </div>
            <div>
                <div class="flex justify-between text-xs text-gray-500 mb-1">
                    <span>Daily XP</span>
                    <span id="xpProgressText">0 / 50</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="xpProgressFill" class="bg-indigo-600 h-2 rounded-full w-0"></div>
                </div>
            </div>
            <div id="nextBadgeCard" class="bg-indigo-50 text-indigo-700 p-3 rounded-lg text-sm font-medium">
                üéØ Next Badge: Starter (50 XP)
            </div>
            <div>
                <h4 class="text-xs font-semibold text-gray-500 mb-1">Last 7 Days</h4>
                <div id="streakHeatmap" class="flex gap-1 justify-center"></div>
            </div>
            <div id="tipBox" class="italic text-sm text-gray-600">
                ‚ÄúConsistency beats intensity.‚Äù
            </div>
            <div id="dailyChallenge" class="bg-emerald-50 text-emerald-700 p-3 rounded-lg text-sm font-medium">
                üéØ Challenge: Complete 2 lessons today!
            </div>
            <button id="completeLessonBtn" class="mt-2 w-full bg-indigo-600 text-white rounded-lg py-2 hover:bg-indigo-700 transition">+10 XP Lesson</button>
            <button id="syncBtn" class="w-full border border-indigo-200 rounded-lg py-2 text-indigo-600 hover:bg-indigo-100 transition">Sync</button>
            <div class="mt-4 grid grid-cols-2 gap-3 text-left text-sm bg-gray-50 p-3 rounded-lg min-w-0">
                <div>
                    <label class="block text-gray-400 text-xs">Email</label>
                    <div id="sideProfileEmail" class="font-medium break-words">‚Äî</div>
                </div>
                <div>
                    <label class="block text-gray-400 text-xs">Language</label>
                    <div id="sideProfileLang" class="font-medium break-words">‚Äî</div>
                </div>
                <div>
                    <label class="block text-gray-400 text-xs">Phone</label>
                    <div id="sideProfilePhone" class="font-medium">‚Äî</div>
                </div>
                <div>
                    <label class="block text-gray-400 text-xs">State</label>
                    <div id="sideProfileState" class="font-medium">‚Äî</div>
                </div>
                <div>
                    <label class="block text-gray-400 text-xs">10th School</label>
                    <div id="sideProfileSchool10" class="font-medium break-words">‚Äî</div>
                </div>
                <div>
                    <label class="block text-gray-400 text-xs">10th %</label>
                    <div id="sideProfilePercent10" class="font-medium">‚Äî</div>
                </div>
                <div>
                    <label class="block text-gray-400 text-xs">12th School</label>
                    <div id="sideProfileSchool12" class="font-medium break-words">‚Äî</div>
                </div>
                <div>
                    <label class="block text-gray-400 text-xs">12th %</label>
                    <div id="sideProfilePercent12" class="font-medium">‚Äî</div>
                </div>
                <div class="col-span-2">
                    <label class="block text-gray-400 text-xs">Stream</label>
                    <div id="sideProfileStream" class="font-medium">‚Äî</div>
                </div>
            </div>
            <button id="editProfileBtn" class="mt-2 w-full bg-emerald-100 text-emerald-700 rounded-lg py-2 hover:bg-emerald-200 transition">‚úèÔ∏è Edit Profile</button>
            <div class="mt-4 grid grid-cols-1 gap-3 text-left text-sm bg-gray-50 p-3 rounded-lg min-w-0">
                <a href="./options.html" class="text-indigo-600 hover:text-indigo-800 font-medium">Learning Options</a>
                <a href="./freelancer.html" class="text-indigo-600 hover:text-indigo-800 font-medium">Freelancer Opportunities</a>
                <a href="./findTeacher.html" class="text-indigo-600 hover:text-indigo-800 font-medium">Find Teacher</a>
                <a href="./counselling.html" class="text-indigo-600 hover:text-indigo-800 font-medium">Counseling</a>
                <a href="./index.html" class="text-indigo-600 hover:text-indigo-800 font-medium">Home</a>
                <button id="logoutBtn" class="text-left text-indigo-600 hover:text-indigo-800 font-medium">Logout</button>
            </div>
        </aside>
        <section class="lg:col-span-9 col-span-12 space-y-6">
            <div id="loadingBanner" class="text-center py-4">
                <span class="loading"></span> Loading Dashboard...
            </div>
            <div id="errorBanner" class="error-banner hidden">
                Using default data (API unavailable). Sync to retry.
            </div>
            <div class="soft-card p-6 flex flex-col md:flex-row md:justify-between md:items-center gap-4">
                <div>
                    <h1 class="text-2xl font-bold">Dashboard</h1>
                    <p id="welcomeLine" class="text-sm text-gray-600">Welcome</p>
                </div>
                <button id="editProfileHeaderBtn" class="px-4 py-2 bg-emerald-100 text-emerald-700 rounded-full hidden md:inline-flex hover:bg-emerald-200 transition">‚úèÔ∏è Edit Profile</button>
            </div>
            <div class="soft-card p-6">
                <h3 class="font-semibold">Activity</h3>
                <div class="mt-4 flex flex-col lg:flex-row items-center gap-6">
                    <svg width="120" height="120" viewBox="0 0 120 120" class="xp-circle" aria-label="XP progress circle" role="img">
                        <circle cx="60" cy="60" r="50" stroke="#e5e7eb" stroke-width="12" fill="none" />
                        <circle id="xpStroke" cx="60" cy="60" r="50" stroke="url(#grad)" stroke-width="12" stroke-linecap="round" stroke-dasharray="314" stroke-dashoffset="314" fill="none" />
                        <defs>
                            <linearGradient id="grad" x1="0" x2="1">
                                <stop offset="0%" stop-color="#667eea" />
                                <stop offset="100%" stop-color="#764ba2" />
                            </linearGradient>
                        </defs>
                        <text id="xpLabel" x="60" y="65" text-anchor="middle" font-size="16" font-weight="600" fill="#4b5563">0%</text>
                    </svg>
                    <div>
                        <div id="dailyXpText" class="text-lg font-semibold">0 XP</div>
                        <div class="text-xs text-gray-500">Goal: <span id="xpGoal">50</span> XP</div>
                    </div>
                    <div class="flex-1 w-full">
                        <canvas id="activityChart" height="100" aria-label="Activity chart" role="img"></canvas>
                    </div>
                </div>
            </div>
            <div class="soft-card p-6">
                <h3 class="font-semibold">Badges</h3>
                <div id="badgesList" class="mt-3 flex flex-wrap gap-3"></div>
            </div>
            <div class="soft-card p-6">
                <h3 class="font-semibold">Recent Learnings</h3>
                <div id="recentList" class="mt-3 grid sm:grid-cols-2 gap-3"></div>
            </div>
            <div class="soft-card p-6">
                <h3 class="font-semibold">Leaderboard</h3>
                <div id="leaderboardList" class="mt-3 space-y-2"></div>
            </div>
            <div class="soft-card p-6">
                <h3 class="font-semibold">My Courses</h3>
                <div id="coursesList" class="mt-3 grid sm:grid-cols-2 gap-4"></div>
            </div>
        </section>
    </main>
    <div id="editModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50" role="dialog" aria-modal="true" aria-labelledby="editProfileTitle">
        <div class="bg-white rounded-xl p-6 w-full max-w-md max-h-[90vh] overflow-auto shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 id="editProfileTitle" class="text-lg font-semibold">Edit Profile</h3>
                <button id="closeModal" class="text-gray-500" aria-label="Close modal">‚úï</button>
            </div>
            <div class="space-y-3">
                <div class="flex items-center gap-3">
                    <img id="modalAvatarPreview" src="https://via.placeholder.com/80" class="w-16 h-16 rounded-full object-cover border" alt="Avatar preview">
                    <div class="flex-1">
                        <label for="editAvatar" class="text-xs text-gray-500">Avatar</label>
                        <input id="editAvatar" type="file" accept="image/*" class="w-full text-xs mt-1" />
                    </div>
                </div>
                <div>
                    <label for="editName" class="text-xs text-gray-400">Name</label>
                    <input id="editName" class="w-full mt-1 p-2 rounded border" />
                </div>
                <div>
                    <label for="editRole" class="text-xs text-gray-400">Role</label>
                    <select id="editRole" class="w-full mt-1 p-2 rounded border">
                        <option value="Student">Student</option>
                        <option value="Teacher">Teacher</option>
                    </select>
                </div>
                <div>
                    <label for="editEmail" class="text-xs text-gray-400">Email</label>
                    <input id="editEmail" class="w-full mt-1 p-2 rounded border" />
                </div>
                <div>
                    <label for="editLang" class="text-xs text-gray-400">Language</label>
                    <input id="editLang" class="w-full mt-1 p-2 rounded border" />
                </div>
                <div>
                    <label for="editPhone" class="text-xs text-gray-400">Phone</label>
                    <input id="editPhone" class="w-full mt-1 p-2 rounded border" />
                </div>
                <div>
                    <label for="editState" class="text-xs text-gray-400">State</label>
                    <input id="editState" class="w-full mt-1 p-2 rounded border" />
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label for="editSchool10" class="text-xs text-gray-400">10th School</label>
                        <input id="editSchool10" class="w-full mt-1 p-2 rounded border" />
                    </div>
                    <div>
                        <label for="editPercent10" class="text-xs text-gray-400">10th %</label>
                        <input id="editPercent10" class="w-full mt-1 p-2 rounded border" />
                    </div>
                    <div>
                        <label for="editSchool12" class="text-xs text-gray-400">12th School</label>
                        <input id="editSchool12" class="w-full mt-1 p-2 rounded border" />
                    </div>
                    <div>
                        <label for="editPercent12" class="text-xs text-gray-400">12th %</label>
                        <input id="editPercent12" class="w-full mt-1 p-2 rounded border" />
                    </div>
                </div>
                <div>
                    <label for="editStream" class="text-xs text-gray-400">Stream</label>
                    <input id="editStream" class="w-full mt-1 p-2 rounded border" />
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-4">
                <button id="cancelEdit" class="px-4 py-2 bg-gray-100 rounded hover:bg-gray-200 transition">Cancel</button>
                <button id="saveEdit" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">Save</button>
            </div>
        </div>
    </div>
    <script>
        const fallback = {
            user: {
                name: "Demo User",
                role: "Student",
                avatar: "",
                email: "demo@univyze.com",
                language: "English",
                phone: "+91 98765 43210",
                state: "Maharashtra",
                school10: "ABC High School",
                percent10: "88%",
                school12: "XYZ Jr College",
                percent12: "85%",
                stream: "Science",
                crowns: 20,
                streak: 32,
                gems: 3,
                totalXP: 120,
                dailyXP: 18,
                xpGoal: 50
            },
            activity: [5, 8, 12, 15, 20, 12, 18],
            badges: [
                { title: "Starter", threshold: 50, icon: "ü•â" },
                { title: "Silver", threshold: 100, icon: "ü•à" },
                { title: "Gold", threshold: 200, icon: "ü•á" }
            ],
            recent: [
                { title: "English Proficiency Lesson 1", xp: 10 },
                { title: "Career Counseling Session", xp: 12 }
            ],
            leaderboard: [
                { name: "Priya", xp: 220 },
                { name: "Rahul", xp: 180 },
                { name: "Aisha", xp: 160 },
                { name: "John", xp: 140 },
                { name: "You", xp: 120 }
            ],
            courses: [
                { title: "English Proficiency", progress: 40 },
                { title: "Career Counseling", progress: 15 }
            ]
        };
        let data = { ...fallback };
        let chart = null;
        let tipInterval = null;
        let fetchErrors = 0;

        async function fetchUserData() {
            const token = localStorage.getItem('token');
            if (!token) return;
            try {
                const response = await axios.get('/api/user', {
                    headers: { Authorization: `Bearer ${token}` }
                });
                data.user = { ...data.user, ...response.data };
            } catch (error) {
                console.error('Error fetching user data:', error);
                fetchErrors++;
            }
        }

        async function fetchProgressData() {
            const token = localStorage.getItem('token');
            if (!token) return;
            try {
                const response = await axios.get('/api/progress', {
                    headers: { Authorization: `Bearer ${token}` }
                });
                data.user.dailyXP = response.data.dailyXP || data.user.dailyXP;
                data.user.totalXP = response.data.totalXP || data.user.totalXP;
                data.activity = response.data.activity || data.activity;
            } catch (error) {
                console.error('Error fetching progress data:', error);
                fetchErrors++;
            }
        }

        async function fetchCourses() {
            const token = localStorage.getItem('token');
            if (!token) return;
            try {
                const response = await axios.get('/api/courses', {
                    headers: { Authorization: `Bearer ${token}` }
                });
                data.courses = response.data || data.courses;
            } catch (error) {
                console.error('Error fetching courses:', error);
                fetchErrors++;
            }
        }

        async function fetchLeaderboard() {
            try {
                const response = await axios.get('/api/leaderboard');
                data.leaderboard = response.data || data.leaderboard;
            } catch (error) {
                console.error('Error fetching leaderboard:', error);
                fetchErrors++;
            }
        }

        function setXP(current, goal) {
            if (!data || typeof current === 'undefined') return;
            const percent = Math.min((current / goal) * 100, 100);
            const offset = 314 - (314 * percent) / 100;
            const stroke = document.getElementById("xpStroke");
            if (stroke) stroke.setAttribute("stroke-dashoffset", offset);
            const label = document.getElementById("xpLabel");
            if (label) label.textContent = Math.round(percent) + "%";
            const dailyXpText = document.getElementById("dailyXpText");
            if (dailyXpText) dailyXpText.textContent = `${current} XP`;
            const xpGoal = document.getElementById("xpGoal");
            if (xpGoal) xpGoal.textContent = goal;
        }

        function setProgressBar(current, goal) {
            if (!data || typeof current === 'undefined') return;
            const percent = Math.min((current / goal) * 100, 100);
            const fill = document.getElementById("xpProgressFill");
            if (fill) fill.style.width = percent + "%";
            const text = document.getElementById("xpProgressText");
            if (text) text.textContent = `${current} / ${goal}`;
        }

        function renderHeatmap() {
            if (!data || !data.activity) return;
            const heatmap = document.getElementById("streakHeatmap");
            if (!heatmap) return;
            heatmap.innerHTML = "";
            const days = ["S", "M", "T", "W", "T", "F", "S"];
            data.activity.forEach((val, i) => {
                const color = val > 0 ? `bg-indigo-${Math.min(val * 100, 500)}` : "bg-gray-200";
                heatmap.innerHTML += `<div class="w-6 h-6 rounded ${color} flex items-center justify-center text-xs text-white" title="${days[i]}: ${val} XP">${days[i]}</div>`;
            });
        }

        function renderChart(activity) {
            if (!activity || activity.length === 0) return;
            const canvas = document.getElementById("activityChart");
            if (!canvas) return;
            const ctx = canvas.getContext("2d");
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
                    datasets: [{
                        label: "XP Earned",
                        data: activity,
                        borderColor: "#667eea",
                        backgroundColor: "rgba(102, 126, 234, 0.2)",
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: "XP" } },
                        x: { title: { display: true, text: "Day" } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderBadges() {
            if (!data || !data.badges) return;
            const badgesList = document.getElementById("badgesList");
            if (!badgesList) return;
            badgesList.innerHTML = "";
            data.badges.forEach(badge => {
                const achieved = (data.user.totalXP || 0) >= badge.threshold;
                const opacity = achieved ? "" : "opacity-50";
                badgesList.innerHTML += `
                    <div class="p-3 bg-gray-50 rounded-lg flex items-center gap-2 ${opacity}">
                        <span class="text-2xl">${badge.icon}</span>
                        <div>
                            <div class="font-medium">${badge.title}</div>
                            <div class="text-xs text-gray-500">${achieved ? "Achieved" : `Need ${badge.threshold} XP`}</div>
                        </div>
                    </div>`;
            });
            const nextBadge = data.badges.find(b => (data.user.totalXP || 0) < b.threshold) || data.badges[data.badges.length - 1];
            const nextCard = document.getElementById("nextBadgeCard");
            if (nextCard) nextCard.textContent = `üéØ Next Badge: ${nextBadge.title} (${data.user.totalXP || 0}/${nextBadge.threshold} XP)`;
        }

        function renderRecent() {
            if (!data || !data.recent) return;
            const recentList = document.getElementById("recentList");
            if (!recentList) return;
            recentList.innerHTML = "";
            data.recent.forEach(item => {
                recentList.innerHTML += `
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <div class="font-medium">${item.title}</div>
                        <div class="text-xs text-gray-500">+${item.xp} XP</div>
                    </div>`;
            });
        }

        function renderLeaderboard() {
            if (!data || !data.leaderboard) return;
            const leaderboardList = document.getElementById("leaderboardList");
            if (!leaderboardList) return;
            leaderboardList.innerHTML = "";
            data.leaderboard.forEach((entry, i) => {
                const highlight = entry.name === "You" ? "bg-indigo-50 text-indigo-700" : "";
                leaderboardList.innerHTML += `
                    <div class="flex justify-between p-2 rounded-lg ${highlight}">
                        <div>${i + 1}. ${entry.name}</div>
                        <div>${entry.xp} XP</div>
                    </div>`;
            });
        }

        function renderCourses() {
            if (!data || !data.courses) return;
            const coursesList = document.getElementById("coursesList");
            if (!coursesList) return;
            coursesList.innerHTML = "";
            data.courses.forEach(course => {
                coursesList.innerHTML += `
                    <div class="p-4 bg-gray-50 rounded-lg flex items-center gap-3">
                        <div class="w-full">
                            <div class="font-medium">${course.title}</div>
                            <div class="text-xs text-gray-500">Progress: ${course.progress}%</div>
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                                <div class="bg-indigo-600 h-2 rounded-full" style="width: ${course.progress}%"></div>
                            </div>
                        </div>
                    </div>`;
            });
        }

        function startRotateTips() {
            if (tipInterval) return;
            const tips = [
                "Consistency beats intensity.",
                "Explore freelancer opportunities to earn while learning!",
                "Book a counseling session to plan your career.",
                "Complete daily lessons to boost your XP."
            ];
            let i = 0;
            const tipBox = document.getElementById("tipBox");
            if (tipBox) tipBox.textContent = tips[i];
            tipInterval = setInterval(() => {
                i = (i + 1) % tips.length;
                if (tipBox) tipBox.textContent = tips[i];
            }, 5000);
        }

        function render() {
            if (!data || !data.user) return;
            const u = data.user;

            const avatar = document.getElementById("userAvatar");
            if (avatar) avatar.src = u.avatar || "https://via.placeholder.com/100";
            const modalAvatar = document.getElementById("modalAvatarPreview");
            if (modalAvatar) modalAvatar.src = u.avatar || "https://via.placeholder.com/80";
            const userName = document.getElementById("userName");
            if (userName) userName.textContent = u.name;
            const userRole = document.getElementById("userRole");
            if (userRole) {
                userRole.textContent = u.role;
                userRole.className = `text-xs text-gray-500 role-pill role-${u.role.toLowerCase()}`;
            }
            const welcomeLine = document.getElementById("welcomeLine");
            if (welcomeLine) welcomeLine.textContent = `Welcome ${u.name}`;

            const statCrowns = document.getElementById("statCrowns");
            if (statCrowns) statCrowns.textContent = u.crowns || 0;
            const statStreak = document.getElementById("statStreak");
            if (statStreak) statStreak.textContent = u.streak || 0;
            const statGems = document.getElementById("statGems");
            if (statGems) statGems.textContent = u.gems || 0;

            const sideProfileEmail = document.getElementById("sideProfileEmail");
            if (sideProfileEmail) sideProfileEmail.textContent = u.email || "‚Äî";
            const sideProfileLang = document.getElementById("sideProfileLang");
            if (sideProfileLang) sideProfileLang.textContent = u.language || "‚Äî";
            const sideProfilePhone = document.getElementById("sideProfilePhone");
            if (sideProfilePhone) sideProfilePhone.textContent = u.phone || "‚Äî";
            const sideProfileState = document.getElementById("sideProfileState");
            if (sideProfileState) sideProfileState.textContent = u.state || "‚Äî";
            const sideProfileSchool10 = document.getElementById("sideProfileSchool10");
            if (sideProfileSchool10) sideProfileSchool10.textContent = u.school10 || "‚Äî";
            const sideProfilePercent10 = document.getElementById("sideProfilePercent10");
            if (sideProfilePercent10) sideProfilePercent10.textContent = u.percent10 || "‚Äî";
            const sideProfileSchool12 = document.getElementById("sideProfileSchool12");
            if (sideProfileSchool12) sideProfileSchool12.textContent = u.school12 || "‚Äî";
            const sideProfilePercent12 = document.getElementById("sideProfilePercent12");
            if (sideProfilePercent12) sideProfilePercent12.textContent = u.percent12 || "‚Äî";
            const sideProfileStream = document.getElementById("sideProfileStream");
            if (sideProfileStream) sideProfileStream.textContent = u.stream || "‚Äî";

            setXP(u.dailyXP || 0, u.xpGoal || 50);
            setProgressBar(u.dailyXP || 0, u.xpGoal || 50);

            renderHeatmap();
            renderChart(data.activity);
            renderBadges();
            renderRecent();
            renderLeaderboard();
            renderCourses();
            startRotateTips();

            const loadingBanner = document.getElementById("loadingBanner");
            if (loadingBanner) loadingBanner.style.display = "none";
            const errorBanner = document.getElementById("errorBanner");
            if (errorBanner) errorBanner.classList.toggle("hidden", fetchErrors === 0);
        }

        document.getElementById("completeLessonBtn").addEventListener("click", async () => {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Please log in to complete lessons.');
                return;
            }
            try {
                await axios.post('/api/progress/complete', { xpIncrement: 10 }, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                data.user.dailyXP = (data.user.dailyXP || 0) + 10;
                data.user.totalXP = (data.user.totalXP || 0) + 10;
                render();
            } catch (error) {
                console.error('Error completing lesson:', error);
                alert('Failed to update progress. Using local update.');
                data.user.dailyXP = (data.user.dailyXP || 0) + 10;
                data.user.totalXP = (data.user.totalXP || 0) + 10;
                render();
            }
        });

        document.getElementById("syncBtn").addEventListener("click", async () => {
            fetchErrors = 0;
            await Promise.all([fetchUserData(), fetchProgressData(), fetchCourses(), fetchLeaderboard()]);
            render();
        });

        function openModal() {
            document.getElementById("editModal").classList.remove("hidden");
            const u = data.user || {};
            const editName = document.getElementById("editName");
            if (editName) editName.value = u.name || "";
            const editRole = document.getElementById("editRole");
            if (editRole) editRole.value = u.role || "Student";
            const editEmail = document.getElementById("editEmail");
            if (editEmail) editEmail.value = u.email || "";
            const editLang = document.getElementById("editLang");
            if (editLang) editLang.value = u.language || "";
            const editPhone = document.getElementById("editPhone");
            if (editPhone) editPhone.value = u.phone || "";
            const editState = document.getElementById("editState");
            if (editState) editState.value = u.state || "";
            const editSchool10 = document.getElementById("editSchool10");
            if (editSchool10) editSchool10.value = u.school10 || "";
            const editPercent10 = document.getElementById("editPercent10");
            if (editPercent10) editPercent10.value = u.percent10 || "";
            const editSchool12 = document.getElementById("editSchool12");
            if (editSchool12) editSchool12.value = u.school12 || "";
            const editPercent12 = document.getElementById("editPercent12");
            if (editPercent12) editPercent12.value = u.percent12 || "";
            const editStream = document.getElementById("editStream");
            if (editStream) editStream.value = u.stream || "";
        }

        document.getElementById("editProfileBtn").addEventListener("click", openModal);
        document.getElementById("editProfileHeaderBtn").addEventListener("click", openModal);

        document.getElementById("closeModal").addEventListener("click", () => {
            document.getElementById("editModal").classList.add("hidden");
        });

        document.getElementById("cancelEdit").addEventListener("click", () => {
            document.getElementById("editModal").classList.add("hidden");
        });

        document.getElementById("saveEdit").addEventListener("click", async () => {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Please log in to save profile.');
                return;
            }
            const updatedProfile = {
                name: document.getElementById("editName").value,
                role: document.getElementById("editRole").value,
                email: document.getElementById("editEmail").value,
                language: document.getElementById("editLang").value,
                phone: document.getElementById("editPhone").value,
                state: document.getElementById("editState").value,
                school10: document.getElementById("editSchool10").value,
                percent10: document.getElementById("editPercent10").value,
                school12: document.getElementById("editSchool12").value,
                percent12: document.getElementById("editPercent12").value,
                stream: document.getElementById("editStream").value
            };
            try {
                await axios.put('/api/user', updatedProfile, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                data.user = { ...data.user, ...updatedProfile };
                document.getElementById("editModal").classList.add("hidden");
                render();
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Failed to save profile. Changes saved locally.');
                data.user = { ...data.user, ...updatedProfile };
                document.getElementById("editModal").classList.add("hidden");
                render();
            }
        });

        document.getElementById("editAvatar").addEventListener("change", async (e) => {
            const file = e.target.files[0];
            if (file) {
                const formData = new FormData();
                formData.append("avatar", file);
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('Please log in to upload avatar.');
                    return;
                }
                try {
                    const response = await axios.post('/api/user/avatar', formData, {
                        headers: {
                            Authorization: `Bearer ${token}`,
                            "Content-Type": "multipart/form-data"
                        }
                    });
                    data.user.avatar = response.data.avatarUrl;
                    const modalAvatar = document.getElementById("modalAvatarPreview");
                    if (modalAvatar) modalAvatar.src = data.user.avatar;
                    render();
                } catch (error) {
                    console.error('Error uploading avatar:', error);
                    alert('Failed to upload avatar. Using placeholder.');
                }
            }
        });

        document.getElementById("logoutBtn").addEventListener("click", () => {
            localStorage.removeItem('token');
            window.location.href = './signin.html';
        });

        async function init() {
            const token = localStorage.getItem('token');
            if (!token) {
                console.warn('No token found. Rendering default dashboard.');
                fetchErrors = 4;
                render();
                return;
            }
            const loadingBanner = document.getElementById("loadingBanner");
            if (loadingBanner) loadingBanner.style.display = "block";

            await Promise.all([fetchUserData(), fetchProgressData(), fetchCourses(), fetchLeaderboard()]);

            if (loadingBanner) loadingBanner.style.display = "none";
            render();
        }
        init();
    </script>
</body>
</html>