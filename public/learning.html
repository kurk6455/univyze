<script>
(function() {
    'use strict';

    const brainsMax = 5;
    let brains = brainsMax;
    let xp = 0;
    let currentQuestion = null;
    let selectedOptions = [];
    let questionCount = 0;
    const totalQuestions = 10;

    const brainsDiv = document.getElementById("brains");
    const questionElem = document.getElementById("question");
    const pageTitle = document.getElementById("pageTitle");
    const questionCounter = document.getElementById("questionCounter");
    const quizSection = document.getElementById("quiz-section");
    const questionDisplay = document.getElementById("question-display");
    const answersDiv = document.getElementById("answers");
    const submitBtn = document.getElementById("submitBtn");
    const skipBtn = document.getElementById("skipBtn");
    const feedbackMessage = document.getElementById("feedbackMessage");
    const errorMessage = document.getElementById("errorMessage");
    const xpBar = document.getElementById("xp-bar");
    const brainsPopup = document.getElementById("brainsPopup");
    const refillBtn = document.getElementById("refillBtn");
    const loadingOverlay = document.getElementById("loading");
    const congratsMessage = document.getElementById("congratsMessage");
    const finalXp = document.getElementById("finalXp");
    const goBackBtn = document.getElementById("goBackBtn");

    // Get topic from URL parameters or localStorage with fallback (lowercase for consistency)
    const urlParams = new URLSearchParams(window.location.search);
    let topic = urlParams.get('topic') || localStorage.getItem('selectedTopic') || 'magnetism';
    topic = topic.toLowerCase();  // Ensure lowercase
    localStorage.setItem('selectedTopic', topic);
    pageTitle.textContent = `${topic.charAt(0).toUpperCase() + topic.slice(1)} Learning`;
    const apiUrl = `/api/topic/${encodeURIComponent(topic)}`;

    console.log('Topic:', topic, 'API URL:', apiUrl);  // Debug log

    // Get token from localStorage for auth
    const token = localStorage.getItem('token');
    if (!token) {
        alert('Please log in to access the learning content.');
        window.location.href = '/signin.html';
        return;  // Now scoped inside IIFE
    }

    // Create Axios instance with auth header
    const api = axios.create({
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    });

    function updateBrains() {
        brainsDiv.textContent = "üß†".repeat(brains) + "ü§ç".repeat(brainsMax - brains);
    }

    function updateXp() {
        const width = Math.min((xp / 100) * 100, 100);
        xpBar.style.width = `${width}%`;
    }

    function showError(msg) {
        console.error('Error:', msg);  // Debug log
        errorMessage.textContent = msg;
        errorMessage.style.display = 'block';
        loadingOverlay.style.display = 'none';
    }

    function updateQuestionCounter() {
        questionCounter.textContent = `${questionCount + 1}/${totalQuestions}`;
    }

    function loadQuestion(q) {
        if (!q) {
            showError('No question data received. Please try again.');
            return;
        }
        feedbackMessage.textContent = "";
        submitBtn.disabled = true;
        selectedOptions = [];
        questionDisplay.style.display = 'none';
        answersDiv.style.display = '';
        quizSection.style.display = 'flex';
        errorMessage.style.display = 'none';

        const type = q.type || 'multiple-choice';
        console.log('Loading question:', q);  // Debug log

        if (type === 'fill-in-the-blanks') {
            questionElem.innerHTML = q.prompt ? q.prompt.replace('_____', '<input type="text" id="fillInput" autocomplete="off" style="background: #34495e; color: white; border: 1px solid #2c3e50; padding: 0.5rem; border-radius: 4px;">') : 'Loading prompt...';
            quizSection.style.display = 'none';

            const input = document.getElementById('fillInput');
            if (input) {
                input.focus();
                input.addEventListener('input', () => {
                    submitBtn.disabled = input.value.trim() === '';
                });
            }
        } else {
            questionElem.textContent = q.prompt || 'What is this?';
            answersDiv.innerHTML = "";

            const options = q.options || [];
            if (options.length === 0) {
                answersDiv.innerHTML = '<div class="answer-option">No options available.</div>';
                return;
            }

            options.forEach((opt, index) => {
                const div = document.createElement("div");
                div.className = "answer-option";
                div.tabIndex = 0;

                let displayText = '';
                if (typeof opt === 'object' && opt !== null) {
                    if (opt.imageUrl && type === 'visual') {
                        const img = document.createElement("img");
                        img.src = opt.imageUrl;
                        img.alt = opt.description || '';
                        img.onerror = () => { img.style.display = 'none'; };
                        div.appendChild(img);
                    }
                    displayText = opt.value || opt.description || 'Option';
                } else {
                    displayText = opt || 'Option';
                }

                const span = document.createElement("span");
                span.textContent = displayText;
                div.appendChild(span);

                div.addEventListener("click", () => {
                    Array.from(answersDiv.children).forEach(child => child.classList.remove("selected"));
                    div.classList.add("selected");
                    selectedOptions = [index];
                    submitBtn.disabled = false;
                });

                div.addEventListener("keydown", (e) => {
                    if (e.key === "Enter" || e.key === " ") {
                        e.preventDefault();
                        div.click();
                    }
                });

                answersDiv.appendChild(div);
            });
        }

        submitBtn.disabled = true;
        skipBtn.disabled = false;
    }

    async function fetchNextQuestion(isCorrect = null, userAnswer = null) {
        if (questionCount >= totalQuestions) {
            loadingOverlay.style.display = 'none';
            showCompletion();
            return;
        }

        loadingOverlay.style.display = 'flex';
        submitBtn.disabled = true;
        skipBtn.disabled = true;
        feedbackMessage.textContent = "";

        try {
            const progressData = {
                xp: xp,
                isCorrect: isCorrect,
                brains: brains,
                questionId: currentQuestion ? currentQuestion.id : null,
                userAnswer: userAnswer,
                topic: topic,
                questionNumber: questionCount
            };

            console.log('Fetching next question with data:', progressData);  // Debug log

            const response = await api.post(apiUrl, progressData);
            console.log('API Response:', response.data);  // Debug log

            if (response.data && response.data.prompt) {
                currentQuestion = response.data;
                questionCount++;
                updateQuestionCounter();
                loadQuestion(currentQuestion);
            } else if (response.data && response.data.completed) {
                showCompletion();
            } else {
                throw new Error('Invalid question data from server');
            }
        } catch (error) {
            console.error('Fetch error:', error);  // Enhanced logging
            if (error.response && error.response.status === 401) {
                alert('Session expired. Please log in again.');
                localStorage.removeItem('token');
                window.location.href = '/signin.html';
                return;
            } else if (error.response && error.response.status >= 500) {
                showError('Server error. Please try again later.');
            } else if (error.response && error.response.status === 404) {
                showError('No questions available for this topic. Try another topic.');
            } else {
                showError('Error loading question. Check your connection and try again.');
            }
            submitBtn.disabled = false;
            skipBtn.disabled = false;
        } finally {
            loadingOverlay.style.display = 'none';
        }
    }

    function checkAnswer() {
        if (!currentQuestion) return;
        submitBtn.disabled = true;
        skipBtn.disabled = true;
        const type = currentQuestion.type || 'multiple-choice';
        let isCorrect = false;
        let userAnswer = null;

        if (type === 'fill-in-the-blanks') {
            const input = document.getElementById('fillInput');
            if (input) {
                userAnswer = input.value.trim().toLowerCase();
                const correct = (currentQuestion.correctAnswer || '').toLowerCase();
                isCorrect = userAnswer === correct;

                if (isCorrect) {
                    input.style.border = '2px solid #27ae60';
                    feedbackMessage.style.color = "#27ae60";
                } else {
                    input.style.border = '2px solid #e74c3c';
                    feedbackMessage.style.color = "#e74c3c";
                }
            }
        } else {
            const selectedIdx = selectedOptions[0];
            const options = currentQuestion.options || [];
            if (selectedIdx !== undefined && selectedIdx < options.length) {
                if (typeof options[selectedIdx] === 'object' && options[selectedIdx] !== null) {
                    userAnswer = options[selectedIdx].value || options[selectedIdx];
                } else {
                    userAnswer = options[selectedIdx];
                }
            }

            let correctIdx = -1;
            const correctAnswer = currentQuestion.correctAnswer;
            options.forEach((opt, idx) => {
                const optVal = typeof opt === 'object' ? (opt.value || opt) : opt;
                if (optVal === correctAnswer) {
                    correctIdx = idx;
                }
            });

            isCorrect = selectedIdx === correctIdx;

            Array.from(answersDiv.children).forEach((optionDiv, idx) => {
                optionDiv.classList.remove("selected");
                if (idx === correctIdx) {
                    optionDiv.classList.add("correct");
                }
                if (idx === selectedIdx && !isCorrect && selectedIdx !== undefined) {
                    optionDiv.classList.add("incorrect");
                }
            });
        }

        const feedback = currentQuestion.feedback || (isCorrect ? 'Great job!' : 'Keep trying!');
        feedbackMessage.textContent = (isCorrect ? "Awesome! " : "Incorrect. ") + feedback;
        feedbackMessage.style.color = isCorrect ? "#27ae60" : "#e74c3c";

        if (isCorrect) {
            xp += 10;
            updateXp();
        } else {
            brains--;
            updateBrains();
        }

        if (brains <= 0) {
            brainsPopup.style.display = "flex";
        } else if (questionCount < totalQuestions) {
            setTimeout(() => fetchNextQuestion(isCorrect, userAnswer), 1500);
        } else {
            showCompletion();
        }
    }

    function skipQuestion() {
        if (questionCount < totalQuestions) {
            fetchNextQuestion(null, null);
        } else {
            showCompletion();
        }
    }

    function showCompletion() {
        quizSection.style.display = 'none';
        submitBtn.style.display = 'none';
        skipBtn.style.display = 'none';
        feedbackMessage.style.display = 'none';
        congratsMessage.style.display = 'block';
        finalXp.textContent = xp;
    }

    // Event listeners
    skipBtn.addEventListener("click", skipQuestion);
    submitBtn.addEventListener("click", checkAnswer);
    refillBtn.addEventListener("click", () => {
        brains = brainsMax;
        updateBrains();
        brainsPopup.style.display = "none";
        fetchNextQuestion(null, null);
    });
    goBackBtn.addEventListener("click", () => {
        window.location.href = '/options.html';
    });

    // Initialize
    updateBrains();
    updateXp();
    updateQuestionCounter();
    fetchNextQuestion(null, null);
})();
</script>